---
name: 1 - Pull Requests

on:
  push:
    branches:
      - 28-analyze-dhall-files

concurrency:
  group: '${{ github.workflow }} @ ${{ github.head_ref || github.ref }}'
  cancel-in-progress: true

jobs:
  check-linting:
    runs-on: minafoundation-toolchain-jammy-runners
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
      - name: 📥 Checkout git submodules
        run: git submodule update --recursive --remote --init
      - uses: tj-actions/changed-files@v39
        id: changed
        with:
          files_yaml: |
            src:
              - 'src/**'
            rfcs:
              - 'rfcs/**'
            xref:
              - '*.md'
              - '.xrefcheck.yaml'
      - name: 🧩 Get opam dependency cache
        uses: actions/cache@v3
        id: opam_dependencies
        with:
          path: ~/.opam
          key: mina_opam_dependencies-${{ hashFiles('./opam.export') }}
      - name: 🏗️ Build opam dependencies
        run: |
          opam switch import opam.export --quiet
          eval $(opam config env) \
          && ./scripts/pin-external-packages.sh \
          && opam clean --logs -cs --quiet
      - name: 📝 OCaml Lints
        if: steps.changed.outputs.src_any_changed == 'true'
        uses: ./.github/actions/ocaml-lint
      - name: 📝 Fast Lints
        if: steps.changed.outputs.src_any_changed == 'true' || steps.changed.outputs.rfcs_any_changed == 'true'
        uses: ./.github/actions/fast-lint
        continue-on-error: true
        with:
          ref_name: ${{ github.ref_name }}
      - name: 📝 Xrefcheck
        if: steps.changed.outputs.xref_any_changed == 'true'
        uses: serokell/xrefcheck-action@v1
        with:
          xrefcheck-version: 0.1.2
