on:
  workflow_call:
    inputs:
      changed_paths:
        description: 'Paths where changes took place'
        required: true
        type: string
jobs:
  ocaml-lint:
    if: contains(inputs.changed_paths, 'src')
    name: "OCaml Lints"
    runs-on: minafoundation-toolchain-jammy-runners
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: ğŸ§© Get opam dependency cache
        uses: actions/cache@v3
        id: opam_dependencies
        with:
          path: ~/.opam
          key: mina_opam_dependencies-${{ hashFiles('./opam.export') }}
      - name: ğŸ—ï¸ Build opam dependencies
        run: |
          opam switch import opam.export --quiet
          eval "$(opam config env)"
          ./scripts/pin-external-packages.sh
          opam clean --logs -cs --quiet
      - name: ğŸ“ OCaml Lints
        uses: ./.github/actions/ocaml-lint
  fast-lint:
    if: contains(inputs.changed_paths, 'src') || contains(inputs.changed_paths, 'rfcs')
    name: "Fast Lints"
    runs-on: minafoundation-toolchain-jammy-runners
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: ğŸ§© Get opam dependency cache
        uses: actions/cache@v3
        id: opam_dependencies
        with:
          path: ~/.opam
          key: mina_opam_dependencies-${{ hashFiles('./opam.export') }}
      - name: ğŸ—ï¸ Build opam dependencies
        run: |
          opam switch import opam.export --quiet
          eval $(opam config env) \
          && ./scripts/pin-external-packages.sh \
          && opam clean --logs -cs --quiet
      - name: ğŸ“ Fast Lints
        uses: ./.github/actions/fast-lint
        continue-on-error: true
        with:
          ref_name: ${{ github.ref_name }}
  xrefcheck-lint:
    if: contains(inputs.changed_paths, 'xref')
    name: "Xrefcheck"
    runs-on: minafoundation-toolchain-jammy-runners
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: ğŸ“ Xrefcheck
        uses: serokell/xrefcheck-action@v1
        with:
          xrefcheck-version: 0.2
  validation-service-lint:
    if: contains(inputs.changed_paths, 'validation')
    name: "Validation Service"
    runs-on: minafoundation-toolchain-jammy-runners
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
      - name: ğŸ“ Validation service
        uses: ./.github/actions/validation-service
